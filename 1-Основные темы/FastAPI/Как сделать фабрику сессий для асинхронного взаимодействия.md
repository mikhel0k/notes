#базы_данных #подключение #FastAPI #postgresql #фабрика_сессий #асинхронное_программирование

```
from dotenv import load_dotenv  
import os  
  
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker, AsyncSession
```
Для начала импортируем все необходимые библиотеки:
- `load_dotenv` из `dotenv` нужен чтобы загрузить информацию из файла .env, созданного ранее, чуть подробнее про его содержимое для работы с базой данных; [[Как получить адрес для подключения к базе данных (на примере PostgreSQL)]]
- `os` нужен для того что записать в конкретные переменные загруженную информацию из файла .env;
- `create_async_engine` из `sqlalchemy.ext.asyncio` нужен чтобы создать асинхронный движок для работы с базой данных,
- `async_sessionmaker` как раз создает фабрику сессий,
- А при помощи класса `AsyncSession` мы скажем фабрике объекты какого класса она будет возвращать.

```
load_dotenv()  
  
ASYNC_DATABASE_URL = os.getenv(  
    "ASYNC_DATABASE_URL",  
    "postgresql+asyncpg://user:password@localhost:5432/fastapi_db"  
)
```
Вот тут я при помощи `load_dotenv` загружаю переменные из .env файла и при помощи `os.getenv` записываю их в переменную  `ASYNC_DATABASE_URL`, если ничего не будет найдено я сделаю подключение по url по умолчанию.

Сессия - единица работы с базой данных, в которой отслеживаются изменения в объектах Python, делаются запросы в SQL, кэшируются ответы и все взаимодействие проекта с базой данных происходит через сессии #Сессия

```
async_engine = create_async_engine(ASYNC_DATABASE_URL)
```
Создаю асинхронный движок для обращения к базе данных. Движок управляет пулом соединений, в программе одновременно существует несколько соединений с базой данных, когда идет большая нагрузка движок увеличивает количество соединений, когда нагрузка падает он может вообще закрыть все соединения.

```
AsyncSessionLocal = async_sessionmaker(  
    async_engine,
    class_=AsyncSession,
    expire_on_commit=False,
	autoflush=False,
)
```
Создаю асинхронную фабрику сессий. Фабрика сессий запрашивает у движка подключение, ожидает пока движок отдаст ее, потом создает сессию, в сессии уже через соединение выполняется какой-то запрос после чего сессия будет закрыта, а соединение вернется в пул движка.
Параметр`autoflush=False` отвечает за то чтобы в коде все запросы выполнялись после указания об этом в коде, по умолчанию запросы выполняются сразу как вносятся изменения в сессию, указав этот флаг нужно явно прописывать каждую отправку запросов.
`expire_on_commit=False` сохраняет состояние объектов после коммита, иначе выполнив commit в базу данных информация об объектах в памяти объекта будет удалена.

```
async def get_db():
    async with AsyncSessionLocal() as session:
        try:
            yield session
        finally:  
            await session.close()
```
Сделал функцию для асинхронного получения асинхронной сессии. Это просто обертка благодаря которой более безопасно и удобно можно получать сессию у фабрики сессий.
